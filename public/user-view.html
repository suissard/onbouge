<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Profil Utilisateur - SportConnect</title>

		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<script src="https://unpkg.com/lucide@latest"></script>

		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="js/config.js"></script>
		<script src="js/main.js" defer></script>

		<style>
			main {
				padding: 2rem 0;
			}
			.view-layout {
				display: grid;
				grid-template-columns: 2fr 1fr;
				gap: 2rem;
				align-items: flex-start;
			}
			.user-title-group {
				display: flex;
				justify-content: space-between;
				align-items: center;
				gap: 1rem;
			}
			.user-title {
				font-size: 2rem;
				font-weight: 700;
				margin: 0;
			}
			#follow-btn {
				background: none;
				border: none;
				cursor: pointer;
				padding: 0.5rem;
			}
			#follow-btn .icon {
				color: var(--gray-400);
				transition: all 0.2s;
				width: 28px;
				height: 28px;
			}
			#follow-btn.active .icon {
				color: var(--blue-600);
				fill: var(--blue-600);
			}
			#user-map {
				height: 250px;
				width: 100%;
				border-radius: 0.75rem;
				margin-top: 1rem;
				z-index: 1;
			}
			.sport-tag {
				text-transform: capitalize;
			}

			@media (max-width: 900px) {
				.view-layout {
					grid-template-columns: 1fr;
				}
			}
		</style>
	    <link rel="stylesheet" href="style.css" />
</head>
	<body>
		<main>
			<div class="container">
				<div class="view-layout">
					<!-- Colonne de gauche : Infos publiques -->
					<div class="main-content">
						<div class="user-title-group">
							<h1 id="user-name" class="user-title"></h1>
							<button id="follow-btn" title="Suivre cette personne">
								<i data-lucide="user-plus" class="icon"></i>
							</button>
						</div>
						<p id="user-description" style="margin-top: 1rem"></p>
						<h4 style="margin-top: 2rem">Sports pratiqu√©s</h4>
						<div id="user-sports" class="sport-tags"></div>
					</div>

					<!-- Colonne de droite : Carte et statut -->
					<div class="side-panel">
						<h4>Statut</h4>
						<p>R√¥le : <b id="user-role"></b></p>
						<p>Visibilit√© : <b id="user-privacy"></b></p>
						<h4 style="margin-top: 2rem">Localisation</h4>
						<div id="user-map"></div>
					</div>
				</div>
			</div>
		</main>

		<script>
			// public/js/user-view.js

			document.addEventListener("DOMContentLoaded", async () => {
				// Attend que l'API soit initialis√©e
				while (typeof api === 'undefined') {
					await new Promise(resolve => setTimeout(resolve, 100));
				}

				const userId = getURLParameter('id');
				if (!userId) {
					console.error("No user ID found in URL");
					document.getElementById('user-name').textContent = "Utilisateur non trouv√©";
					return;
				}

				try {
					const user = await api.get('users', userId, { populate: '*' });
					renderUserDetails(user);
					// Assuming the API returns position data in a similar format
					if (user.position && user.position.length >= 2) {
						initMap(user.position[0], user.position[1]);
					}
				} catch (error) {
					console.error("Error fetching user data:", error);
					document.getElementById('user-name').textContent = "Erreur de chargement";
				}
			});

			function renderUserDetails(data) {
				document.getElementById("user-name").textContent = data.username;
				document.getElementById("user-description").textContent = data.description;
				document.getElementById("user-role").textContent = data.role;
				document.getElementById("user-privacy").textContent = data.privacy
					? "Priv√©"
					: "Public";

				const sportsContainer = document.getElementById("user-sports");
				sportsContainer.innerHTML = (data.sports || [])
					.map((s) => `<span class="sport-tag">${s.replace(".", " ")}</span>`)
					.join("");

				const followBtn = document.getElementById("follow-btn");
				followBtn.classList.toggle("active", data.isFollowed);

				followBtn.addEventListener("click", () => {
					data.isFollowed = !data.isFollowed;
					followBtn.classList.toggle("active", data.isFollowed);
					// Changer l'ic√¥ne pour mieux refl√©ter l'√©tat
					followBtn.innerHTML = data.isFollowed
						? '<i data-lucide="user-check" class="icon"></i>'
						: '<i data-lucide="user-plus" class="icon"></i>';
					lucide.createIcons();
				});

				lucide.createIcons();
			}

			function initMap(homePos, lastPos) {
				const map = L.map("user-map").setView(homePos, 11);
				L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

				L.marker(homePos, { icon: createIcon("üè†") })
					.addTo(map)
					.bindPopup("Domicile");
				L.marker(lastPos, { icon: createIcon("üë£") })
					.addTo(map)
					.bindPopup("Derni√®re position");
			}

			function createIcon(emoji) {
				return L.divIcon({
					html: emoji,
					className: "map-emoji-icon",
					iconSize: [24, 24],
					iconAnchor: [12, 24],
				});
			}
		</script>
	</body>
</html>
