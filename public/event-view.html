<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Voir Événement - SportConnect</title>

		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<script src="https://unpkg.com/lucide@latest"></script>

		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="js/config.js"></script>
		<script src="js/main.js" defer></script>


		<style>
			main {
				padding: 2rem 0;
			}
			.view-layout {
				display: grid;
				grid-template-columns: 2fr 1fr;
				gap: 2rem;
				align-items: flex-start;
			}
			.event-title-group {
				display: flex;
				justify-content: space-between;
				align-items: center;
				gap: 1rem;
			}
			.event-title {
				font-size: 2rem;
				font-weight: 700;
				margin: 0;
			}
			#favorite-btn {
				background: none;
				border: none;
				cursor: pointer;
				padding: 0.5rem;
			}
			#favorite-btn .icon {
				color: var(--gray-400);
				transition: all 0.2s;
				width: 28px;
				height: 28px;
			}
			#favorite-btn.active .icon {
				color: var(--yellow-400);
				fill: var(--yellow-400);
			}
			.event-meta {
				display: flex;
				gap: 1.5rem;
				margin: 1rem 0;
				color: var(--gray-600);
				font-weight: 500;
			}
			.event-meta div {
				display: flex;
				align-items: center;
				gap: 0.5rem;
			}
			.event-actions {
				margin-top: 1.5rem;
				display: flex;
				gap: 1rem;
			}
			#event-map {
				height: 250px;
				width: 100%;
				border-radius: 0.75rem;
				margin-top: 1rem;
				z-index: 1;
			}
			@media (max-width: 900px) {
				.view-layout {
					grid-template-columns: 1fr;
				}
			}
		</style>
	    <link rel="stylesheet" href="style.css" />
</head>
	<body>
		<main>
			<div class="container">
				<div class="view-layout">
					<!-- Colonne de gauche : Détails -->
					<div class="main-content">
						<div class="event-title-group">
							<h1 id="event-title" class="event-title"></h1>
							<button id="favorite-btn" title="Ajouter aux favoris">
								<i data-lucide="star" class="icon"></i>
							</button>
						</div>
						<div class="event-meta">
							<div id="event-date">
								<i data-lucide="calendar" class="icon"></i><span></span>
							</div>
							<div id="event-type">
								<i data-lucide="tag" class="icon"></i><span></span>
							</div>
						</div>
						<p id="event-description"></p>
						<div id="event-sports" class="sport-tags"></div>
						<div class="event-actions">
							<button id="participate-btn" class="btn btn-primary">
								<i data-lucide="check" class="icon"></i>Je participe
							</button>
							<button class="btn-secondary">
								<i data-lucide="share-2" class="icon"></i>Partager
							</button>
						</div>
					</div>

					<!-- Colonne de droite : Infos et carte -->
					<div class="side-panel">
						<h4>Participants</h4>
						<div class="participants" style="margin-bottom: 1.5rem">
							<div id="avatar-group" class="avatar-group"></div>
							<p>
								<span id="public-participants"></span> publics et
								<span id="anon-participants"></span> anonymes.
							</p>
						</div>
						<div id="event-map"></div>
					</div>
				</div>

				<!-- Section Forum -->
				<div id="forum-section" class="main-content" style="margin-top: 2rem">
					<h2><i data-lucide="messages-square" class="icon"></i>Forum de discussion</h2>
					<div id="forum-topics"></div>
				</div>
			</div>
		</main>

		<script>
			// public/js/event-view.js

			document.addEventListener("DOMContentLoaded", async () => {
				// Attend que l'API soit initialisée
				while (typeof api === 'undefined') {
					await new Promise(resolve => setTimeout(resolve, 100));
				}

				const eventId = getURLParameter('id');
				if (!eventId) {
					console.error("No event ID found in URL");
					document.getElementById('event-title').textContent = "Événement non trouvé";
					return;
				}

				try {
					const event = await api.get('events', eventId, { populate: '*' });
					renderEventDetails(event);
					renderForum(event.topics || []);
					if(event.position) {
						initMap(event.position, event.title);
					}

				} catch (error) {
					console.error("Error fetching event data:", error);
					document.getElementById('event-title').textContent = "Erreur de chargement";
				}
			});

			function renderEventDetails(data) {
				document.getElementById("event-title").textContent = data.title;
				document.getElementById("event-description").textContent = data.description;
				document.querySelector("#event-date span").textContent = new Date(data.date).toLocaleDateString('fr-FR');
				document.querySelector("#event-type span").textContent = data.type;

				const sportsContainer = document.getElementById("event-sports");
				sportsContainer.innerHTML = (data.sport || [])
					.map((s) => `<span class="sport-tag">${s.replace(".", " ")}</span>`)
					.join("");

				document.getElementById("public-participants").textContent = data.nb_users_public || 0;
				document.getElementById("anon-participants").textContent = data.nb_users_anonymes || 0;

				const avatarContainer = document.getElementById("avatar-group");
				avatarContainer.innerHTML = (data.participants || [])
					.map((p) => `<div class="avatar">${p}</div>`)
					.join("");

				const favoriteBtn = document.getElementById("favorite-btn");
				favoriteBtn.classList.toggle("active", data.isFavorite);

				favoriteBtn.addEventListener("click", () => {
					data.isFavorite = !data.isFavorite;
					favoriteBtn.classList.toggle("active", data.isFavorite);
				});

				lucide.createIcons();
			}

			function renderForum(topics) {
				const topicsContainer = document.getElementById("forum-topics");
				topicsContainer.innerHTML = topics
					.map(
						(topic) => `
    <div class="forum-topic">
        <div class="topic-header">
            <span>${topic.title}</span>
            <i data-lucide="chevron-down" class="icon"></i>
        </div>
        <div class="topic-messages">
            <div class="forum-messages-list">
                ${(topic.messages || [])
                    .map(
                        (msg) => `
                    <div class="forum-message">
                        <header><span class="author">${
                            msg.author
                        }</span><span>${new Date(msg.date).toLocaleDateString(
                    "fr-FR"
                )}</span></header>
                        <p>${msg.text}</p>
                    </div>`
                    )
                    .join("")}
            </div>
            <form class="forum-form" style="margin-top: 1rem;">
                <div class="form-full">
                    <input type="text" placeholder="Écrire un message..." required>
                    <button type="submit" class="btn-secondary">Envoyer</button>
                </div>
            </form>
        </div>
    </div>`
					)
					.join("");

				document.querySelectorAll(".topic-header").forEach((header) => {
					header.addEventListener("click", () => {
						header.classList.toggle("active");
						header.nextElementSibling.classList.toggle("active");
					});
				});
			}

			function initMap(position, title) {
				const map = L.map("event-map").setView(position, 13);
				L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
				L.marker(position).addTo(map).bindPopup(title).openPopup();
			}
		</script>
	</body>
</html>
